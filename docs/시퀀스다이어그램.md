# 콘서트 티켓팅 시퀀스 다이어그램

## 1.대기열 토큰 발급/조회
 > [!NOTE]
 > 놀이공원(유량제어) 방식 대기열 구현으로 표현
1. 사용자는 토큰 발급 API 호출합니다.
2. 대기열 도메인에서 데이터베이스에 사용자 정보로 대기열에 등록되어있는지 조회를 요청합니다.
3. 조회 결과에 따라 
    - 대기열에 등록되지 않은경우
        - 대기열에 사용자를 등록합니다. (WAIT 상태)
    - 이미 등록된 경우
        - 대기열에 등록된 사용자 상태를 반환합니다.
4. 사용자에게 토큰을 반환합니다.

```mermaid
sequenceDiagram
    actor A as 사용자
    participant B as 대기열 시스템
    participant C as 데이터베이스
    A ->> +B: 토큰 발급 요청
    B ->> +C: 사용자 대기열 등록 확인
    C -->> -B: 조회 결과 반환
        alt is 대기열에 등록되지 않은 경우
            B ->> +C: 대기열 등록 (WAIT)
            C -->> -B : 유저 등록 확인
            B -->> A : 대기열 등록 완료
        else is 이미 등록 된 경우
            B ->> +C: 유저 상태 조회
            C -->> -B: 유저 상태 반환
            B -->> -A: 대기열 상태 반환 (상태, 번호)
        end
        loop n초 마다 m명의 유저대기열 진입
            B ->> +C: m명의 유저 상태 변경(WAIT -> ACTIVE)
            C -->> -B: 업데이트 확인
    end
```

## 2.예약가능 날짜 조회
```mermaid
sequenceDiagram
actor A as 사용자
participant B as 콘서트 도메인
participant C as 데이터베이스

    A ->> +B: 콘서트 날짜 조회 요청
    B ->> +C: 날짜 목록 조회 
    C -->> -B: 응답 
    B -->> -A: 조회 목록 반환
    A ->> +B: 선택 날짜 좌석 조회 요청
    B ->> +C: 공연 좌석 조회
    C -->> -B: 응답
    B -->> -A: 선택날짜 좌석 정보 응답

```

## 3.좌석예약 요청
```mermaid
sequenceDiagram
    actor A as 사용자
    participant B as 예약 도메인
    participant C as 좌석 도메인
    participant D as 데이터베이스
    
    A ->> +B : 좌석예약 요청
    B ->> +C : 좌석상태 요청
    C ->> +D : 좌석상태 조회
    D -->> -C : 좌석상태 반환
    C -->> -B : 좌석상태 반환
    
    alt is 예약가능
        B ->> +C : 예약요청
        C ->> +D : 좌석 상태 업데이트(임시배정)
        D -->> -C : 업데이트 확인
        C -->> -B : 업데이트 확인
        B -->> A : 예약 성공 응답
    else is 예약 불가
        B -->> -A: 예약 실패 응답
    end

```

## 4.잔액 조회/충전 요청
```mermaid
sequenceDiagram
    actor A as 사용자
    participant B as 사용자 도메인
    participant C as 데이터베이스
    
    A ->> +B : 잔액 조회 요청
    B ->> +C : 잔액 조회 요청
    C -->> -B : 잔액 조회 응답
    B -->> -A : 잔액 조회 응답
    A ->> +B : 잔액 충전 요청
    B ->> +C : 충전 잔액 업데이트
    C -->> -B : 업데이트 완료
    B -->> -A : 충전 완료 응답
```

## 5. 결제 API
> 좌석예약에서 이미 좌석상태에 대해 검증했기 때문에 결제만 진행
1. 사용자는 결제 요청을 합니다.
2. 결제 도메인은 사용자 도메인에 잔액 조회를 요청하여 데이터베이스에서 잔액을 조회합니다.
3. 반환 결과에따라
    - 잔액이 충분한경우
        - 사용자 잔액에서 결제 잔액을 뺀 금액을 업데이트합니다.
        - 잔액 차감에 성공하면 결제도메인에서 결제내역 업데이트를 요청합니다.
        - 완료되면 성공 결과를 반환합니다.
    - 잔액이 부족한경우
        - 잔액이 부족하여 실패한 결과를 반환합니다.
```mermaid
sequenceDiagram
    actor A as 사용자
    participant B as 결제 도메인
    participant C as 사용자 도메인
    participant D as 데이터베이스
    
    A ->> +B : 결제 요청
    B ->> +C : 잔액 조회 요청
    C ->> +D : 잔액 조회
    D -->> -C : 조회 잔액 응답
    alt is 잔액 충분
       C ->> +D : 잔액 차감 상태 업데이트
       D -->> -C : 업데이트 확인
       C -->> B : 잔액 차감 성공
       B ->> +D : 결제 내역 업데이트
       D -->> B : 업데이트 확인
       B -->> A : 결제 완료
    else is 잔액 부족
       D -->> -C : 잔액 부족 응답
       C -->> -B : 잔액 부족 응답
       B -->> -A : 잔액 부족 응답
    end
```
